version: '3.8'

services:
  # MongoDB Database
  mongodb:
    image: mongo:7.0
    container_name: waiting-room-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_DATABASE: waiting_room
    volumes:
      - mongodb_data:/data/db
      - ./scripts/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    networks:
      - waiting-room-network

  # API Server
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: waiting-room-api
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      MONGODB_URI: mongodb://mongodb:27017/waiting_room
      ADDR: ":8080"
    depends_on:
      - mongodb
    networks:
      - waiting-room-network

  # Kiosk Application
  kiosk:
    build:
      context: ./ui
      dockerfile: Dockerfile.kiosk
    container_name: waiting-room-kiosk
    restart: unless-stopped
    ports:
      - "4201:4201"
    depends_on:
      - api
    networks:
      - waiting-room-network

  # Mobile Application
  mobile:
    build:
      context: ./ui
      dockerfile: Dockerfile.mobile
    container_name: waiting-room-mobile
    restart: unless-stopped
    ports:
      - "4202:4202"
    depends_on:
      - api
    networks:
      - waiting-room-network

  # TV Display
  tv:
    build:
      context: ./ui
      dockerfile: Dockerfile.tv
    container_name: waiting-room-tv
    restart: unless-stopped
    ports:
      - "4203:4203"
    depends_on:
      - api
    networks:
      - waiting-room-network

  # Backoffice
  backoffice:
    build:
      context: ./ui
      dockerfile: Dockerfile.backoffice
    container_name: waiting-room-backoffice
    restart: unless-stopped
    ports:
      - "4200:4200"
    depends_on:
      - api
    networks:
      - waiting-room-network

  # Card Reader (optional - for development)
  card-reader:
    build:
      context: ./card-reader
      dockerfile: Dockerfile
    container_name: waiting-room-card-reader
    restart: unless-stopped
    privileged: true  # Required for smart card access
    devices:
      - /dev/bus/usb:/dev/bus/usb  # USB device access for card readers
    environment:
      ROOM_ID: triage-1
      DEVICE_ID: reader-01
      WS_URL: ws://kiosk:4201/ws/card-reader
    depends_on:
      - kiosk
    networks:
      - waiting-room-network

volumes:
  mongodb_data:

networks:
  waiting-room-network:
    driver: bridge
